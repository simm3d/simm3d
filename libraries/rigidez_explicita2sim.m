function [KE,diagonal]=rigidez_explicita2sim(v,E,G)

coord=G.nodes.coords;
conec=double(G.elements.lnods);

[b1,b2,b3,b4,c1,c2,c3,c4,d1,d2,d3,d4]=coeficientes(coord,conec);
VV=volume_tetra(conec,coord);
KE=zeros(G.elements.nelem,78);
diagonal=zeros(G.elements.nelem,12);
E=E(:)';
KE(:,1)= (E.*(2*b1.*b1*v + 2*c1.*c1*v + 2*d1.^2*v - 2*b1.*b1 - c1.*c1 - d1.*d1))./(72*VV*(2*v^2 + v - 1));
diagonal(:,1)=KE(:,1);

KE(:,2)=-(E.*b1.*c1)./(72*VV*(2*v^2 + v - 1));

KE(:,3)= -(E.*b1.*d1)./(72*VV*(2*v^2 + v - 1));

KE(:,4)=-(E.*(2*b1.*b2 + c1.*c2 + d1.*d2 - 2*b1.*b2*v - 2*c1.*c2*v - 2*d1.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,5)=-(E.*(b2.*c1 + 2*b1.*c2*v - 2*b2.*c1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,6)=-(E.*(b2.*d1 + 2*b1.*d2*v - 2*b2.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,7)=-(E.*(2*b1.*b3 + c1.*c3 + d1.*d3 - 2*b1.*b3*v - 2*c1.*c3*v - 2*d1.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,8)=-(E.*(b3.*c1 + 2*b1.*c3*v - 2*b3.*c1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,9)=-(E.*(b3.*d1 + 2*b1.*d3*v - 2*b3.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,10)=-(E.*(2*b1.*b4 + c1.*c4 + d1.*d4 - 2*b1.*b4*v - 2*c1.*c4*v - 2*d1.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,11)=-(E.*(b4.*c1 + 2*b1.*c4*v - 2*b4.*c1*v))./(72*VV*(2*v^2 + v - 1));                               

KE(:,12)=-(E.*(b4.*d1 + 2*b1.*d4*v - 2*b4.*d1*v))./(72*VV*(2*v^2 + v - 1));
                 
KE(:,13)=(E.*(2*b1.^2*v + 2*c1.^2*v + 2*d1.^2*v - b1.^2 - 2*c1.^2 - d1.^2))./(72*VV*(2*v^2 + v - 1));
diagonal(:,2)=KE(:,13);

KE(:,14)=-(E.*c1.*d1)./(72*VV*(2*v^2 + v - 1));

KE(:,15)=-(E.*(b1.*c2 - 2*b1.*c2*v + 2*b2.*c1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,16)=-(E.*(b1.*b2 + 2*c1.*c2 + d1.*d2 - 2*b1.*b2*v - 2*c1.*c2*v - 2*d1.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,17)=-(E.*(c2.*d1 + 2*c1.*d2*v - 2*c2.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,18)=-(E.*(b1.*c3 - 2*b1.*c3*v + 2*b3.*c1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,19)=-(E.*(b1.*b3 + 2*c1.*c3 + d1.*d3 - 2*b1.*b3*v - 2*c1.*c3*v - 2*d1.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,20)=-(E.*(c3.*d1 + 2*c1.*d3*v - 2*c3.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,21)=-(E.*(b1.*c4 - 2*b1.*c4*v + 2*b4.*c1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,22)=-(E.*(b1.*b4 + 2*c1.*c4 + d1.*d4 - 2*b1.*b4*v - 2*c1.*c4*v - 2*d1.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,23)=-(E.*(c4.*d1 + 2*c1.*d4*v - 2*c4.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,24)=(E.*(2*b1.*b1*v + 2*c1.*c1*v + 2*d1.*d1*v - b1.*b1 - c1.*c1 - 2*d1.*d1))./(72*VV*(2*v^2 + v - 1));
diagonal(:,3)=KE(:,24);

KE(:,25)=-(E.*(b1.*d2 - 2*b1.*d2*v + 2*b2.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,26)=-(E.*(c1.*d2 - 2*c1.*d2*v + 2*c2.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,27)= -(E.*(b1.*b2 + c1.*c2 + 2*d1.*d2 - 2*b1.*b2*v - 2*c1.*c2*v - 2*d1.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,28)=-(E.*(b1.*d3 - 2*b1.*d3*v + 2*b3.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,29)=-(E.*(c1.*d3 - 2*c1.*d3*v + 2*c3.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,30)=-(E.*(b1.*b3 + c1.*c3 + 2*d1.*d3 - 2*b1.*b3*v - 2*c1.*c3*v - 2*d1.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,31)=-(E.*(b1.*d4 - 2*b1.*d4*v + 2*b4.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,32)=-(E.*(c1.*d4 - 2*c1.*d4*v + 2*c4.*d1*v))./(72*VV*(2*v^2 + v - 1));

KE(:,33)=-(E.*(b1.*b4 + c1.*c4 + 2*d1.*d4 - 2*b1.*b4*v - 2*c1.*c4*v - 2*d1.*d4*v))./(72*VV*(2*v^2 + v - 1));
 
KE(:,34)= (E.*(2*b2.*b2*v + 2*c2.*c2*v + 2*d2.*d2*v - 2*b2.*b2 - c2.*c2 - d2.*d2))./(72*VV*(2*v^2 + v - 1));
diagonal(:,4)=KE(:,34);

KE(:,35)=-(E.*b2.*c2)./(72*VV*(2*v^2 + v - 1));

KE(:,36)=-(E.*b2.*d2)./(72*VV*(2*v^2 + v - 1));

KE(:,37)=-(E.*(2*b2.*b3 + c2.*c3 + d2.*d3 - 2*b2.*b3*v - 2*c2.*c3*v - 2*d2.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,38)=-(E.*(b3.*c2 + 2*b2.*c3*v - 2*b3.*c2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,39)=-(E.*(b3.*d2 + 2*b2.*d3*v - 2*b3.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,40)=-(E.*(2*b2.*b4 + c2.*c4 + d2.*d4 - 2*b2.*b4*v - 2*c2.*c4*v - 2*d2.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,41)=-(E.*(b4.*c2 + 2*b2.*c4*v - 2*b4.*c2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,42)=-(E.*(b4.*d2 + 2*b2.*d4*v - 2*b4.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,43)=(E.*(2*b2.*b2*v + 2*c2.*c2*v + 2*d2.*d2*v - b2.*b2 - 2*c2.*c2 - d2.*d2))./(72*VV*(2*v^2 + v - 1));
diagonal(:,5)=KE(:,43);

KE(:,44)=-(E.*c2.*d2)./(72*VV*(2*v^2 + v - 1));

KE(:,45)=-(E.*(b2.*c3 - 2*b2.*c3*v + 2*b3.*c2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,46)=-(E.*(b2.*b3 + 2*c2.*c3 + d2.*d3 - 2*b2.*b3*v - 2*c2.*c3*v - 2*d2.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,47)=-(E.*(c3.*d2 + 2*c2.*d3*v - 2*c3.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,48)=-(E.*(b2.*c4 - 2*b2.*c4*v + 2*b4.*c2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,49)=-(E.*(b2.*b4 + 2*c2.*c4 + d2.*d4 - 2*b2.*b4*v - 2*c2.*c4*v - 2*d2.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,50)=-(E.*(c4.*d2 + 2*c2.*d4*v - 2*c4.*d2*v))./(72*VV*(2*v^2 + v - 1));
                             
KE(:,51)=(E.*(2*b2.*b2*v + 2*c2.*c2*v + 2*d2.*d2*v - b2.*b2 - c2.*c2 - 2*d2.*d2))./(72*VV*(2*v^2 + v - 1));
diagonal(:,6)=KE(:,51);

KE(:,52)=-(E.*(b2.*d3 - 2*b2.*d3*v + 2*b3.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,53)=-(E.*(c2.*d3 - 2*c2.*d3*v + 2*c3.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,54)=-(E.*(b2.*b3 + c2.*c3 + 2*d2.*d3 - 2*b2.*b3*v - 2*c2.*c3*v - 2*d2.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,55)=-(E.*(b2.*d4 - 2*b2.*d4*v + 2*b4.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,56)=-(E.*(c2.*d4 - 2*c2.*d4*v + 2*c4.*d2*v))./(72*VV*(2*v^2 + v - 1));

KE(:,57)=-(E.*(b2.*b4 + c2.*c4 + 2*d2.*d4 - 2*b2.*b4*v - 2*c2.*c4*v - 2*d2.*d4*v))./(72*VV*(2*v^2 + v - 1));
                               
KE(:,58)=(E.*(2*b3.*b3*v + 2*c3.*c3*v + 2*d3.*d3*v - 2*b3.*b3 - c3.*c3 - d3.*d3))./(72*VV*(2*v^2 + v - 1));
diagonal(:,7)=KE(:,58);

KE(:,59)=-(E.*b3.*c3)./(72*VV*(2*v^2 + v - 1));

KE(:,60)=-(E.*b3.*d3)./(72*VV*(2*v^2 + v - 1));

KE(:,61)=-(E.*(2*b3.*b4 + c3.*c4 + d3.*d4 - 2*b3.*b4*v - 2*c3.*c4*v - 2*d3.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,62)=-(E.*(b4.*c3 + 2*b3.*c4*v - 2*b4.*c3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,63)=-(E.*(b4.*d3 + 2*b3.*d4*v - 2*b4.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,64)=(E.*(2*b3.*b3*v + 2*c3.*c3*v + 2*d3.*d3*v - b3.*b3 - 2*c3.*c3 - d3.*d3))./(72*VV*(2*v^2 + v - 1));
diagonal(:,8)=KE(:,64);

KE(:,65)=-(E.*c3.*d3)./(72*VV*(2*v^2 + v - 1));

KE(:,66)=-(E.*(b3.*c4 - 2*b3.*c4*v + 2*b4.*c3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,67)=-(E.*(b3.*b4 + 2*c3.*c4 + d3.*d4 - 2*b3.*b4*v - 2*c3.*c4*v - 2*d3.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,68)=-(E.*(c4.*d3 + 2*c3.*d4*v - 2*c4.*d3*v))./(72*VV*(2*v^2 + v - 1));
                              
KE(:,69)=(E.*(2*b3.*b3*v + 2*c3.*c3*v + 2*d3.*d3*v - b3.*b3 - c3.*c3 - 2*d3.*d3))./(72*VV*(2*v^2 + v - 1));
diagonal(:,9)=KE(:,69);

KE(:,70)=-(E.*(b3.*d4 - 2*b3.*d4*v + 2*b4.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,71)=-(E.*(c3.*d4 - 2*c3.*d4*v + 2*c4.*d3*v))./(72*VV*(2*v^2 + v - 1));

KE(:,72)=-(E.*(b3.*b4 + c3.*c4 + 2*d3.*d4 - 2*b3.*b4*v - 2*c3.*c4*v - 2*d3.*d4*v))./(72*VV*(2*v^2 + v - 1));

KE(:,73)=(E.*(2*b4.*b4*v + 2*c4.*c4*v + 2*d4.*d4*v - 2*b4.*b4 - c4.*c4 - d4.*d4))./(72*VV*(2*v^2 + v - 1));
diagonal(:,10)=KE(:,73);

KE(:,74)=-(E.*b4.*c4)./(72*VV*(2*v^2 + v - 1));

KE(:,75)=-(E.*b4.*d4)./(72*VV*(2*v^2 + v - 1));
     
KE(:,76)=(E.*(2*b4.*b4*v + 2*c4.*c4*v + 2*d4.*d4*v - b4.*b4 - 2*c4.*c4 - d4.*d4))./(72*VV*(2*v^2 + v - 1));
diagonal(:,11)=KE(:,76);

KE(:,77)=-(E.*c4.*d4)./(72*VV*(2*v^2 + v - 1));
                           
KE(:,78)=(E.*(2*b4.*b4*v + 2*c4.*c4*v + 2*d4.*d4*v - b4.*b4 - c4.*c4 - 2*d4.*d4))./(72*VV*(2*v^2 + v - 1));
diagonal(:,12)=KE(:,78);
end

function [b1,b2,b3,b4,c1,c2,c3,c4,d1,d2,d3,d4]=coeficientes(coord,conec);

[X1,X2,X3,X4,Y1,Y2,Y3,Y4,Z1,Z2,Z3,Z4]=XYZ(coord,conec);

b1 =Y3.*Z2 - Y2.*Z3 + Y2.*Z4 - Y4.*Z2 - Y3.*Z4 + Y4.*Z3;
c1 =X2.*Z3 - X3.*Z2 - X2.*Z4 + X4.*Z2 + X3.*Z4 - X4.*Z3;
d1 =X3.*Y2 - X2.*Y3 + X2.*Y4 - X4.*Y2 - X3.*Y4 + X4.*Y3;

b2= Y1.*Z3 - Y3.*Z1 - Y1.*Z4 + Y4.*Z1 + Y3.*Z4 - Y4.*Z3;
c2= X3.*Z1 - X1.*Z3 + X1.*Z4 - X4.*Z1 - X3.*Z4 + X4.*Z3;
d2= X1.*Y3 - X3.*Y1 - X1.*Y4 + X4.*Y1 + X3.*Y4 - X4.*Y3;

b3= Y2.*Z1 - Y1.*Z2 + Y1.*Z4 - Y4.*Z1 - Y2.*Z4 + Y4.*Z2;
c3= X1.*Z2 - X2.*Z1 - X1.*Z4 + X4.*Z1 + X2.*Z4 - X4.*Z2;
d3= X2.*Y1 - X1.*Y2 + X1.*Y4 - X4.*Y1 - X2.*Y4 + X4.*Y2;

b4= Y1.*Z2 - Y2.*Z1 - Y1.*Z3 + Y3.*Z1 + Y2.*Z3 - Y3.*Z2;
c4= X2.*Z1 - X1.*Z2 + X1.*Z3 - X3.*Z1 - X2.*Z3 + X3.*Z2;
d4= X1.*Y2 - X2.*Y1 - X1.*Y3 + X3.*Y1 + X2.*Y3 - X3.*Y2;
end

function [X1,X2,X3,X4,Y1,Y2,Y3,Y4,Z1,Z2,Z3,Z4]=XYZ(coord,conec)
X1=coord(conec(:,1)',1)'; Y1=coord(conec(:,1)',2)'; Z1=coord(conec(:,1)',3)';
X2=coord(conec(:,2)',1)'; Y2=coord(conec(:,2)',2)'; Z2=coord(conec(:,2)',3)';
X3=coord(conec(:,3)',1)'; Y3=coord(conec(:,3)',2)'; Z3=coord(conec(:,3)',3)';
X4=coord(conec(:,4)',1)'; Y4=coord(conec(:,4)',2)'; Z4=coord(conec(:,4)',3)';
end

function VV=volume_tetra(conec,coord)

[X1,X2,X3,X4,Y1,Y2,Y3,Y4,Z1,Z2,Z3,Z4]=XYZ(coord,conec);

VV=  1/6*((X1).*(Y3).*(Z2) - (X1).*(Y2).*(Z3) + ...
    (X2).*(Y1).*(Z3) - (X2).*(Y3).*(Z1) - ...
    (X3).*(Y1).*(Z2) + (X3).*(Y2).*(Z1) + ...
    (X1).*(Y2).*(Z4) - (X1).*(Y4).*(Z2) - ...
    (X2).*(Y1).*(Z4) + (X2).*(Y4).*(Z1) + ...
    (X4).*(Y1).*(Z2) - (X4).*(Y2).*(Z1) - ...
    (X1).*(Y3).*(Z4) + (X1).*(Y4).*(Z3) + ...
    (X3).*(Y1).*(Z4) - (X3).*(Y4).*(Z1) - ...
    (X4).*(Y1).*(Z3) + (X4).*(Y3).*(Z1) + ...
    (X2).*(Y3).*(Z4) - (X2).*(Y4).*(Z3) - ...
    (X3).*(Y2).*(Z4) + (X3).*(Y4).*(Z2) + ...
    (X4).*(Y2).*(Z3) - (X4).*(Y3).*(Z2));
end
